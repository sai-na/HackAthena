"use strict";var A=Object.defineProperty,V=Object.defineProperties,q=Object.getOwnPropertyDescriptor,j=Object.getOwnPropertyDescriptors,Z=Object.getOwnPropertyNames,N=Object.getOwnPropertySymbols;var P=Object.prototype.hasOwnProperty,$=Object.prototype.propertyIsEnumerable;var v=(a,e,t)=>e in a?A(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t,u=(a,e)=>{for(var t in e||(e={}))P.call(e,t)&&v(a,t,e[t]);if(N)for(var t of N(e))$.call(e,t)&&v(a,t,e[t]);return a},L=(a,e)=>V(a,j(e));var B=(a,e)=>{for(var t in e)A(a,t,{get:e[t],enumerable:!0})},J=(a,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of Z(e))!P.call(a,i)&&i!==t&&A(a,i,{get:()=>e[i],enumerable:!(r=q(e,i))||r.enumerable});return a};var K=a=>J(A({},"__esModule",{value:!0}),a);var s=(a,e,t)=>new Promise((r,i)=>{var o=l=>{try{p(t.next(l))}catch(d){i(d)}},n=l=>{try{p(t.throw(l))}catch(d){i(d)}},p=l=>l.done?r(l.value):Promise.resolve(l.value).then(o,n);p((t=t.apply(a,e)).next())});var ie={};B(ie,{AUTH_TOKEN_LOCAL_STORAGE_NAME:()=>I,AuthProvider:()=>x,DEVICE_SHARE_LOCAL_STORAGE_NAME:()=>T,DEVICE_SHARE_LOCAL_STORAGE_NAME_DEPRECATED:()=>Y,EMBEDDED_WALLET_PATH:()=>h,PaperEmbeddedWalletSdk:()=>b,UserStatus:()=>R,UserWalletStatus:()=>f,WALLET_USER_ID_LOCAL_STORAGE_NAME:()=>y});module.exports=K(ie);var h="/sdk/2022-08-12/embedded-wallet",y=a=>`paperEwsWalletUserId-${a}`,X="walletToken",I=a=>`${X}-${a}`,G="a",T=(a,e)=>`${G}-${a}-${e}`,Y=a=>`${G}-${a}`;var x=(i=>(i.PAPER_EMAIL_OTP="PaperEmailOTP",i.GOOGLE="Google",i.AUTH0="Auth0",i.CUSTOM_JWT="CustomJWT",i))(x||{});var R=(t=>(t.LOGGED_OUT="Logged Out",t.LOGGED_IN_WALLET_INITIALIZED="Logged In, Wallet Initialized",t))(R||{}),f=(i=>(i.LOGGED_OUT="Logged Out",i.LOGGED_IN_WALLET_UNINITIALIZED="Logged In, Wallet Uninitialized",i.LOGGED_IN_NEW_DEVICE="Logged In, New Device",i.LOGGED_IN_WALLET_INITIALIZED="Logged In, Wallet Initialized",i))(f||{});var k=require("@paperxyz/sdk-common-utilities");var M=new Map,c=class{constructor({clientId:e}){this.isSupported=typeof window!="undefined"&&!!window.localStorage,this.clientId=e}getItem(e){return s(this,null,function*(){var t;return this.isSupported?window.localStorage.getItem(e):(t=M.get(e))!=null?t:null})}setItem(e,t){return s(this,null,function*(){if(this.isSupported)return window.localStorage.setItem(e,t);M.set(e,t)})}removeItem(e){return s(this,null,function*(){let t=yield this.getItem(e);return this.isSupported&&t?(window.localStorage.removeItem(e),!0):!1})}saveAuthCookie(e){return s(this,null,function*(){yield this.setItem(I(this.clientId),e)})}getAuthCookie(){return s(this,null,function*(){return this.getItem(I(this.clientId))})}removeAuthCookie(){return s(this,null,function*(){return this.removeItem(I(this.clientId))})}saveDeviceShare(e,t){return s(this,null,function*(){yield this.saveWalletUserId(t),yield this.setItem(T(this.clientId,t),e)})}getDeviceShare(){return s(this,null,function*(){let e=yield this.getWalletUserId();return e?this.getItem(T(this.clientId,e)):null})}removeDeviceShare(){return s(this,null,function*(){let e=yield this.getWalletUserId();return e?this.removeItem(T(this.clientId,e)):!1})}getWalletUserId(){return s(this,null,function*(){return this.getItem(y(this.clientId))})}saveWalletUserId(e){return s(this,null,function*(){yield this.setItem(y(this.clientId),e)})}removeWalletUserId(){return s(this,null,function*(){return this.removeItem(y(this.clientId))})}};var U=require("@paperxyz/sdk-common-utilities");function W(a){return new Promise(e=>{setTimeout(e,a*1e3)})}var ee={height:"100%",width:"100%",border:"none",backgroundColor:"transparent",position:"fixed",top:"0px",right:"0px",zIndex:"2147483646",display:"none"},O=new Map,_=class{constructor({link:e,iframeId:t,container:r=document.body,iframeStyles:i,onIframeInitialize:o}){this.POLLING_INTERVAL_SECONDS=1.4;this.POST_LOAD_BUFFER_SECONDS=1;let n=document.getElementById(t),p=new URL(e),l="0.0.26";if(!l)throw new Error("Missing SDK_VERSION env var");if(p.searchParams.set("sdkVersion",l),!n||n.src!=p.href){if(!n){n=document.createElement("iframe");let d=u(u({},ee),i);Object.assign(n.style,d),n.setAttribute("id",t),r.appendChild(n)}n.src=p.href,n.setAttribute("data-version",l),n.onload=this.onIframeLoadHandler(n,this.POST_LOAD_BUFFER_SECONDS,o)}this.iframe=n}onIframeLoadedInitVariables(){return s(this,null,function*(){return{}})}onIframeLoadHandler(e,t,r){return()=>s(this,null,function*(){yield new Promise((o,n)=>s(this,null,function*(){var d;let p=new MessageChannel;p.port1.onmessage=w=>{let{data:m}=w;return p.port1.close(),m.success?(O.set(e.src,!0),r&&r(),o(!0)):n(m.error)},yield W(t);let l="initIframe";(d=e==null?void 0:e.contentWindow)==null||d.postMessage({eventType:l,data:yield this.onIframeLoadedInitVariables()},`${(0,U.getPaperOriginUrl)()}${h}`,[p.port2])}))})}call(i){return s(this,arguments,function*({procedureName:e,params:t,showIframe:r=!1}){for(;!O.get(this.iframe.src);)yield W(this.POLLING_INTERVAL_SECONDS);return r&&(this.iframe.style.display="block",yield W(.005)),new Promise((n,p)=>{var d;let l=new MessageChannel;l.port1.onmessage=w=>s(this,null,function*(){let{data:m}=w;l.port1.close(),r&&(yield W(.1),this.iframe.style.display="none"),m.success?n(m.data):p(m.error)}),(d=this.iframe.contentWindow)==null||d.postMessage({eventType:e,data:t},`${(0,U.getPaperOriginUrl)()}${h}`,[l.port2])})})}destroy(){O.delete(this.iframe.src)}};var D=class extends _{constructor({clientId:t,customizationOptions:r}){super({iframeId:re,link:te({clientId:t,path:h,queryParams:r}).href,container:document.body});this.clientId=t}onIframeLoadedInitVariables(){return s(this,null,function*(){let t=new c({clientId:this.clientId});return{authCookie:yield t.getAuthCookie(),deviceShareStored:yield t.getDeviceShare(),walletUserId:yield t.getWalletUserId(),clientId:this.clientId}})}};function te({clientId:a,path:e,queryParams:t}){var i;let r=new URL(e,(0,k.getPaperOriginUrl)());if(r.searchParams.set("clientId",a),t)for(let o of Object.keys(t))r.searchParams.set(o,((i=t[o])==null?void 0:i.toString())||"");return r}var re="paper-embedded-wallet-iframe";var S=class{constructor({clientId:e,querier:t,onAuthSuccess:r}){this.clientId=e,this.AuthQuerier=t,this.localStorage=new c({clientId:e}),this.onAuthSuccess=r}postLogin(r){return s(this,arguments,function*({storedToken:e,walletDetails:t}){return e.shouldStoreCookieString&&(yield this.localStorage.saveAuthCookie(e.cookieString)),yield this.onAuthSuccess({storedToken:e,walletDetails:t})})}loginWithJwtAuth(i){return s(this,arguments,function*({token:e,authProvider:t,recoveryCode:r}){let o=yield this.AuthQuerier.call({procedureName:"loginWithJwtAuthCallback",params:{token:e,authProvider:t,recoveryCode:r}});return this.postLogin(o)})}loginWithPaperModal(){return s(this,null,function*(){let e=yield this.AuthQuerier.call({procedureName:"loginWithPaperModal",params:void 0,showIframe:!0});return this.postLogin(e)})}loginWithPaperEmailOtp(t){return s(this,arguments,function*({email:e}){let r=yield this.AuthQuerier.call({procedureName:"loginWithPaperModal",params:{email:e},showIframe:!0});return this.postLogin(r)})}sendPaperEmailLoginOtp(t){return s(this,arguments,function*({email:e}){let{isNewUser:r,isNewDevice:i}=yield this.AuthQuerier.call({procedureName:"sendPaperEmailLoginOtp",params:{email:e}});return{isNewUser:r,isNewDevice:i}})}verifyPaperEmailLoginOtp(i){return s(this,arguments,function*({email:e,otp:t,recoveryCode:r}){let o=yield this.AuthQuerier.call({procedureName:"verifyPaperEmailLoginOtp",params:{email:e,otp:t,recoveryCode:r}});return this.postLogin(o)})}logout(){return s(this,null,function*(){let{success:e}=yield this.AuthQuerier.call({procedureName:"logout",params:void 0}),t=yield this.localStorage.removeAuthCookie(),r=yield this.localStorage.removeWalletUserId();return{success:e||t||r}})}};var H=require("@ethersproject/providers"),z=require("@paperxyz/sdk-common-utilities");var E=class{constructor({chain:e,clientId:t,querier:r}){this.chain=e,this.clientId=t,this.gaslessTransactionQuerier=r}callContract(i){return s(this,arguments,function*({contractAddress:e,methodArgs:t,methodInterface:r}){return yield this.gaslessTransactionQuerier.call({procedureName:"callContract",params:{chain:this.chain,contractAddress:e,method:{args:t,stub:r}}})})}};var Q=require("@ethersproject/abstract-signer"),F=require("@ethersproject/properties");var g=class extends Q.Signer{constructor({provider:t,clientId:r,querier:i}){super();this.DEFAULT_ETHEREUM_CHAIN_ID=1;this.clientId=r,this.querier=i,(0,F.defineReadOnly)(this,"provider",t)}getAddress(){return s(this,null,function*(){let{address:t}=yield this.querier.call({procedureName:"getAddress",params:void 0});return t})}signMessage(t){return s(this,null,function*(){var i,o,n;let{signedMessage:r}=yield this.querier.call({procedureName:"signMessage",params:{message:t,chainId:(n=(o=yield(i=this.provider)==null?void 0:i.getNetwork())==null?void 0:o.chainId)!=null?n:this.DEFAULT_ETHEREUM_CHAIN_ID}});return r})}signTransaction(t){return s(this,null,function*(){var i,o,n;let{signedTransaction:r}=yield this.querier.call({procedureName:"signTransaction",params:{transaction:t,chainId:(n=(o=yield(i=this.provider)==null?void 0:i.getNetwork())==null?void 0:o.chainId)!=null?n:this.DEFAULT_ETHEREUM_CHAIN_ID}});return r})}_signTypedData(t,r,i){return s(this,null,function*(){var n,p,l;let{signedTypedData:o}=yield this.querier.call({procedureName:"signTypedDataV4",params:{domain:t,types:r,message:i,chainId:(l=(p=yield(n=this.provider)==null?void 0:n.getNetwork())==null?void 0:p.chainId)!=null?l:this.DEFAULT_ETHEREUM_CHAIN_ID}});return o})}connect(t){return new g({clientId:this.clientId,provider:t,querier:this.querier})}};var C=class{constructor({clientId:e,chain:t,querier:r}){this.clientId=e,this.chain=t,this.walletManagerQuerier=r,this.gasless=new E({chain:t,clientId:e,querier:r}),this.localStorage=new c({clientId:e})}postWalletSetUp(o){return s(this,arguments,function*({deviceShareStored:e,walletAddress:t,isIframeStorageEnabled:r,walletUserId:i}){return r||(yield this.localStorage.saveDeviceShare(e,i)),{walletAddress:t}})}getUserWalletStatus(){return s(this,null,function*(){let e=yield this.walletManagerQuerier.call({procedureName:"getUserStatus",params:void 0});return e.status==="Logged In, Wallet Initialized"?{status:"Logged In, Wallet Initialized",user:L(u({},e.user),{wallet:this})}:e})}setChain(t){return s(this,arguments,function*({chain:e}){this.chain=e,this.gasless=new E({chain:e,clientId:this.clientId,querier:this.walletManagerQuerier})})}getEthersJsSigner(e){return s(this,null,function*(){var r;return new g({clientId:this.clientId,provider:(0,H.getDefaultProvider)((r=e==null?void 0:e.rpcEndpoint)!=null?r:z.ChainToPublicRpc[this.chain]),querier:this.walletManagerQuerier})})}};var b=class{constructor({clientId:e,chain:t,styles:r}){this.clientId=e,this.querier=new D({clientId:e,customizationOptions:r}),this.wallet=new C({clientId:e,chain:t,querier:this.querier}),this.auth=new S({clientId:e,querier:this.querier,onAuthSuccess:i=>s(this,null,function*(){return yield this.wallet.postWalletSetUp(L(u({},i.walletDetails),{walletUserId:i.storedToken.authDetails.userWalletId})),{user:{status:"Logged In, Wallet Initialized",authDetails:i.storedToken.authDetails,wallet:this.wallet,walletAddress:i.walletDetails.walletAddress}}})})}getUser(){return s(this,null,function*(){let e=yield this.wallet.getUserWalletStatus();switch(e.status){case"Logged In, New Device":case"Logged In, Wallet Uninitialized":return yield this.auth.logout(),this.getUser();case"Logged Out":return{status:"Logged Out"};case"Logged In, Wallet Initialized":return u({status:"Logged In, Wallet Initialized"},e.user)}})}};0&&(module.exports={AUTH_TOKEN_LOCAL_STORAGE_NAME,AuthProvider,DEVICE_SHARE_LOCAL_STORAGE_NAME,DEVICE_SHARE_LOCAL_STORAGE_NAME_DEPRECATED,EMBEDDED_WALLET_PATH,PaperEmbeddedWalletSdk,UserStatus,UserWalletStatus,WALLET_USER_ID_LOCAL_STORAGE_NAME});
//# sourceMappingURL=index.js.map